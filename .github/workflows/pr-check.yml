name: PR Checks

on:
  pull_request:
    branches: [ main ]

jobs:
  check-conflicts:
    name: Check for merge conflicts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for merge conflicts with main
        run: |
          git fetch origin main
          git merge-base --is-ancestor origin/main HEAD || {
            echo "Branch is behind main, checking for conflicts..."
            git merge --no-commit --no-ff origin/main && echo "✅ No merge conflicts" || {
              echo "❌ Merge conflicts detected!"
              exit 1
            }
          }

  lint-and-validate:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for syntax errors
        run: node --check server.js

      - name: Validate package.json
        run: npm run validate || echo "No validate script defined"

  security-check:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

  pr-title-check:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            test
            chore
